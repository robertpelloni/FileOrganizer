find_package(GTest CONFIG REQUIRED)

add_executable(fo_tests
    test_rule_engine.cpp
    test_export.cpp
    test_hasher.cpp
    test_scanner.cpp
    test_database.cpp
    test_integration.cpp
    test_linter.cpp
)

target_link_libraries(fo_tests PRIVATE GTest::gtest GTest::gtest_main fo_core)

include(GoogleTest)
gtest_discover_tests(fo_tests)

# Fuzzing target (conditional)
option(FO_BUILD_FUZZ_TESTS "Build fuzz tests" OFF)
if(FO_BUILD_FUZZ_TESTS)
    add_executable(fuzz_metadata fuzz/fuzz_metadata.cpp)
    target_link_libraries(fuzz_metadata PRIVATE fo_core)
    # Note: MSVC doesn't support -fsanitize=fuzzer directly in the same way Clang does.
    # On Windows, we might need LibFuzzer linked manually or use Clang-CL.
    # For now, we will just define the target and let the user configure the compiler.
    if(CMAKE_CXX_COMPILER_ID MATCHES "Clang")
        target_compile_options(fuzz_metadata PRIVATE -fsanitize=fuzzer)
        target_link_options(fuzz_metadata PRIVATE -fsanitize=fuzzer)
    endif()

    add_executable(fuzz_rule_engine fuzz/fuzz_rule_engine.cpp)
    target_link_libraries(fuzz_rule_engine PRIVATE fo_core)
    if(CMAKE_CXX_COMPILER_ID MATCHES "Clang")
        target_compile_options(fuzz_rule_engine PRIVATE -fsanitize=fuzzer)
        target_link_options(fuzz_rule_engine PRIVATE -fsanitize=fuzzer)
    endif()
endif()
